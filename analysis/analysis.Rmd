---
title: "analysis"
author: "KSA"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  error = FALSE,
  fig.width = 12,
  fig.height = 10,
  cache = FALSE
)
require("patchwork")
require("data.table")
require("ampvis2")
require("magrittr")
require("stringr")
require("lubridate")
require("tidygraph")
require("ggraph")
require("igraph")
require("patchwork")

#when knitting will always be done in the context of the Rmd file, otherwise not
if (interactive()) {
  if (!grepl("analysis$", getwd())) {
    setwd("analysis")
  }
}
source("functions.R")
set.seed(42)
```

# Prediction accuracy across WWTPs tests
## Graph model incl graph clustering with 3 per group
```{r}
plot_all(
  "results_graph/graph_clustering/3pergroup"
)
```

## Graph model incl graph clustering with 5 per group
```{r}
plot_all(
  "results_graph/graph_clustering/5pergroup"
)
```

## Check some clusters from AAE
```{r}
plot_performance(
  "results_graph/graph_clustering/3pergroup/Aalborg E"
)
plot_performance(
  "results_graph/graph_clustering/5pergroup/Aalborg E"
)
```

# Network plots
```{r}
graph_matrix_list <- list.files(
  "results_graph/graph_clustering/5pergroup/Aalborg E/graph_matrix",
  pattern = "graph_cluster_*",
  full.names = TRUE
)
#list is sorted lexicographically, reorder numerically
order <- graph_matrix_list %>%
  basename %>%
  stringi::stri_extract_all_regex("[0-9]+") %>%
  unlist(use.names = FALSE) %>%
  as.integer %>%
  order
graph_matrix_list <- graph_matrix_list[order]

plot_list <- lapply(
  graph_matrix_list[1:4],
  plot_graph
)

#plots are named after the filenames
plot <- wrap_plots(
  plot_list,
  guides = "collect",
  tag_level = "keep"
)
plot
ggsave(plot = plot, filename = "graph_network_plot.pdf")
```

## Prediction window test
```{r}
plot_all(
  "results_graph/graph_clustering/predwindow_aae",
  add_dataset_info = "predwindow"
)
```

# PCoA (all WWTPs)
```{r PCOA_colored_all}
results_batch_dir <- "results_graph/graph_clustering/5pergroup"
wwtp_results <- list.dirs(
  results_batch_dir,
  full.names = TRUE,
  recursive = FALSE
)

plots <- lapply(
  wwtp_results,
  function(wwtp) {
    plot <- wwtp %>%
      combine_abund(cluster_type = "abund") %>%
      amp_ordinate(
        type = "pcoa",
        distmeasure = "bray",
        transform = "none",
        filter_species = 0,
        sample_color_by = "split_dataset",
        sample_trajectory = "Date",
        sample_trajectory_group = "Date"
      ) +
      scale_color_manual(
        values = c("grey80", RColorBrewer::brewer.pal(3, "Set2")[c(1:3)])
      ) +
      theme(legend.title = element_blank())
    ggsave(
      filename = file.path(
        results_batch_dir,
        paste0("PCoA - ", basename(wwtp), ".png")
      ),
      plot = plot
    )
    return(plot)
  }
)
names(plots) <- basename(wwtp_results)
hideme <- lapply(plots, print)
```

## Time Series examples
```{r timeseries}
results_batch_dir <- "results_graph/graph_clustering/5pergroup"
wwtp_results <- list.dirs(
  results_batch_dir,
  full.names = TRUE,
  recursive = FALSE
)
plots <- lapply(
  wwtp_results,
  function(wwtp) {
    combined <- combine_abund(
      wwtp,
      cluster_type = "abund"
    )
    long <- amp_export_long(
      combined,
      tax_levels = "OTU",
      metadata_vars = c("Date", "split_dataset")
    )

    #check normal distribution
    #qqplot(ASV1, rnorm(1000, mean = mean(ASV1), sd = sd(ASV1)))
    #qqplot(ASV2, rnorm(1000, mean = mean(ASV2), sd = sd(ASV2)))
    ASV1 <- long[grepl("^ASV1;", OTU)]
    if(nrow(ASV1) > 0) {
      plot_asv1 <- plot_timeseries(ASV1, save = FALSE) +
        theme(
          legend.position = "none",
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank()
        ) +
        ggtitle("ASV1 - Tetrasphaera, midas_s_5") +
        scale_y_continuous(breaks = breaks_pretty())
    } else {
      plot_asv1 <- plot_spacer()
    }

    ASV2 <- long[grepl("^ASV2;", OTU)]
    if(nrow(ASV2) > 0) {
      plot_asv2 <- plot_timeseries(ASV2, save = FALSE) +
        theme(
          legend.position = "none",
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank()
        ) +
        ggtitle("ASV2 - Ca. Microthrix, parvicella") +
        scale_y_continuous(breaks = breaks_pretty())
    } else {
      plot_asv2 <- plot_spacer()
    }

    ASV24 <- long[grepl("^ASV24;", OTU)]
    if(nrow(ASV24) > 0) {
      plot_asv24 <- plot_timeseries(ASV24, save = FALSE) +
        theme(legend.position = "bottom") +
        ggtitle("ASV24 - Nitrospira, defluvii") +
        scale_y_continuous(breaks = breaks_pretty())
    } else {
      plot_asv24 <- plot_spacer()
    }

    prediction_example <- plot_asv1 / plot_asv2 / plot_asv24
    ggsave(
      plot = prediction_example,
      filename = file.path(
        results_batch_dir,
        paste0("timeseries example - ", basename(wwtp), ".png")
      ),
      width = 10,
      height = 12
    )

    #plot_timeseries(ASV1, save = TRUE)
    #plot_timeseries(ASV2, save = TRUE)
    #plot_timeseries(ASV3, save = TRUE)
    return(prediction_example)
  }
)
names(plots) <- basename(wwtp_results)
hideme <- lapply(plots, print)

```

# Statistical test of real vs predicted
```{r}
results_batch_dir <- "results_graph/graph_clustering/5pergroup"
wwtp_results <- list.dirs(
  results_batch_dir,
  full.names = TRUE,
  recursive = FALSE
)
statistics <- lapply(
  wwtp_results,
  function(wwtp) {
    combined <- combine_abund(
      wwtp,
      cluster_type = "abund"
    )
    predicted <- amp_filter_samples(
      combined,
      split_dataset %chin% "test",
      predicted %chin% "predicted"
    )
    dates <- predicted[["metadata"]][["Date"]]
    real <- amp_filter_samples(
      combined,
      split_dataset %chin% "real",
      Date %in% dates
    )
    combined <- amp_merge_ampvis2(
      predicted,
      real,
      by_refseq = FALSE
    )
    combined$metadata$predicted <- factor(
      combined$metadata$predicted,
      levels = c("real", "predicted")
    )

    #compare real vs predicted (ANOSIM)
    anosim <- vegan::anosim(
      t(combined$abund),
      combined$metadata$predicted,
      distance = "bray",
      parallel = 30
    )

    #compare real vs predicted (PERMANOVA)
    permanova <- vegan::adonis2(t(combined$abund) ~ predicted, data = combined$metadata, parallel = 10)
    return(list(anosim, permanova))
  }
)
names(statistics) <- basename(wwtp_results)
Rstatistics <- sort(
  unlist(
    lapply(
      statistics,
      function(x) x[[1]][["statistic"]]
    )
  )
)
signifs <- sort(
  unlist(
    lapply(
      statistics,
      function(x) x[[1]][["signif"]]
    )
  )
)
```

# Heatmap of real vs predicted (AAE)
```{r}
realvspredictedheatmap <- amp_heatmap(
  test_combined,
  tax_aggregate = "OTU",
  group_by = c("predicted"),
  normalise = FALSE,
  tax_show = 30,
  plot_values = FALSE,
  facet_by = "Date"
) + theme(strip.text = element_text(angle = 90))
ggsave(
  plot = realvspredictedheatmap,
  filename = "realvspredictedheatmap.png",
  width = 20
)

#compare real vs predicted (ordination)
amp_ordinate(
  test_combined,
  type = "rda",
  constrain = "predicted",
  sample_color_by = "predicted"
)# %>% ggsave(plot = ., filename = "plot.pdf")
```

# Prediction window tests, AAE
```{r}
plot_all(
  "results_20221219_predwindow_wval",
  add_dataset_info = "predwindow",
  plot_width = 8,
  plot_height = 8
)
```

# Timeseries examples, window tests, AAE
```{r}
#visualize the accuracy depending on prediction window length
runs <- list.dirs(
  "results_20221219_predwindow_wval",
  recursive = FALSE,
  full.names = TRUE
)
AAE_predwindowtest <- lapply(
  runs,
  function(rundir) {
    d <- amp_export_long(
      combine_abund(
        rundir,
        cluster_type = "abund"
      ),
      tax_levels = "OTU",
      metadata_vars = c("Date", "split_dataset")
    )
    d[, dataset := basename(rundir)]
  }
)
d <- rbindlist(AAE_predwindowtest)
d[, dataset := factor(
  dataset,
  levels = unique(dataset)[order(as.integer(gsub("[^0-9]*", "", unique(dataset))))])
]

plot_asv1 <- plot_timeseries(
  d[grepl("^ASV1;", OTU)],
  save = FALSE
) +
  facet_grid(rows = vars(dataset))

plot_asv2 <- plot_timeseries(
  d[grepl("^ASV2;", OTU)],
  save = FALSE
) +
  facet_grid(rows = vars(dataset))

plot_asv24 <- plot_timeseries(
  d[grepl("^ASV24;", OTU)],
  save = FALSE
) +
  facet_grid(rows = vars(dataset))

ggsave("predwindowtest_aae_asv1.png", plot = plot_asv1)
ggsave("predwindowtest_aae_asv2.png", plot = plot_asv2)
ggsave("predwindowtest_aae_asv24.png", plot = plot_asv24)
#plot_asv24 <- plot_timeseries(ASV24, save = FALSE) +
#  theme(legend.position = "bottom") +
#  ggtitle("ASV24 - Nitrospira, defluvii")

```

# Prediction window tests, Randers
```{r}
plot_all(
  "results_20230119_predwindow_wval",
  add_dataset_info = "predwindow",
  plot_width = 8,
  plot_height = 8
)
```

# Timeseries examples, window tests, Randers
```{r}
#visualize the accuracy depending on prediction window length
runs <- list.dirs(
  "results_20230119_predwindow_wval",
  recursive = FALSE,
  full.names = TRUE
)
AAE_predwindowtest <- lapply(
  runs,
  function(rundir) {
    d <- amp_export_long(
      combine_abund(
        rundir,
        cluster_type = "abund"
      ),
      tax_levels = "OTU",
      metadata_vars = c("Date", "split_dataset")
    )
    d[, dataset := basename(rundir)]
  }
)
d <- rbindlist(AAE_predwindowtest)
d[, dataset := factor(
  dataset,
  levels = unique(dataset)[order(as.integer(gsub("[^0-9]*", "", unique(dataset))))])
]

plot_asv1 <- plot_timeseries(
  d[grepl("^ASV1;", OTU)],
  save = FALSE
) +
  facet_grid(rows = vars(dataset))

plot_asv2 <- plot_timeseries(
  d[grepl("^ASV2;", OTU)],
  save = FALSE
) +
  facet_grid(rows = vars(dataset))

plot_asv24 <- plot_timeseries(
  d[grepl("^ASV24;", OTU)],
  save = FALSE
) +
  facet_grid(rows = vars(dataset))

ggsave("predwindowtest_randers_asv1.png", plot = plot_asv1)
ggsave("predwindowtest_randers_asv2.png", plot = plot_asv2)
ggsave("predwindowtest_randers_asv24.png", plot = plot_asv24)
#plot_asv24 <- plot_timeseries(ASV24, save = FALSE) +
#  theme(legend.position = "bottom") +
#  ggtitle("ASV24 - Nitrospira, defluvii")

```

# I dunno
```{r}
combine_results <- function(results_batch_dir) {
  runs <- list.dirs(
      results_batch_dir,
      full.names = TRUE,
      recursive = FALSE
    )
    if (length(runs) == 0) {
      stop("No results folders found, wrong working directory?")
    }

    d_list <- lapply(runs, read_results)
    names(d_list) <- runs
    combined <- rbindlist(
      d_list,
      idcol = "results_folder",
      fill = TRUE
    )[
      !is.na(cluster_type) & value > 0
    ]
  return(combined)
}

results <- combine_results("results_20220726_divmean/")
results[grepl("Aalborg E", dataset) & cluster_no == 0, ASV := "ASV1"]
results[grepl("Aalborg E", dataset) & cluster_no == 1, ASV := "ASV2"]
results[grepl("Aalborg W", dataset) & cluster_no == 1, ASV := "ASV2"]
results[grepl("Aalborg W", dataset) & cluster_no == 0, ASV := "ASV1"]
results[grepl("Damhusåen-A", dataset) & cluster_no == 1, ASV := "ASV2"]
results[grepl("Damhusåen-A", dataset) & cluster_no == 2, ASV := "ASV1"]
results[grepl("Damhusåen-B", dataset) & cluster_no == 2, ASV := "ASV1"]
results[grepl("Damhusåen-B", dataset) & cluster_no == 0, ASV := "ASV2"]
results[grepl("Damhusåen-C", dataset) & cluster_no == 0, ASV := "ASV2"]
results[grepl("Damhusåen-C", dataset) & cluster_no == 2, ASV := "ASV1"]
results[grepl("Damhusåen-D", dataset) & cluster_no == 2, ASV := "ASV1"]
results[grepl("Damhusåen-D", dataset) & cluster_no == 1, ASV := "ASV2"]
results[grepl("Ejby Mølle", dataset) & cluster_no == 0, ASV := "ASV1"]
results[grepl("Ejby Mølle", dataset) & cluster_no == 8, ASV := "ASV2"]
results[grepl("Mariagerfjord", dataset) & cluster_no == 0, ASV := "ASV1"]
results[grepl("Mariagerfjord", dataset) & cluster_no == 7, ASV := "ASV2"]
results[grepl("Randers", dataset) & cluster_no == 0, ASV := "ASV2"]
results[grepl("Randers", dataset) & cluster_no == 12, ASV := "ASV1"]
results[grepl("Ribe", dataset) & cluster_no == 2, ASV := "ASV1"]
results <- results[ASV %chin% paste0("ASV", 1:2)]

```

```{r fivenum_BC_ASV}
runs <- list.dirs(
  "results_20221210_wval",
  full.names = TRUE,
  recursive = FALSE
)

d_list <- lapply(runs, read_results)
names(d_list) <- runs
combined <- rbindlist(
  d_list,
  idcol = "results_folder",
  fill = TRUE
)[
  !is.na(cluster_type) & value > 0
]
combined[, .(fivenum_stats = fivenum(value)), by = .(cluster_type, error_metric)]
```

```{r fivenum_reads}
#five number statistics of sum of reads per data set
list.dirs(
  "results_20221210_wval",
  full.names = TRUE,
  recursive = FALSE
) %>%
  lapply(function(dataset) {
    abund <- fread(
      file.path(dataset, "data_reformatted", "abundances.csv"),
      drop = 1
    )
    fivenum(rowSums(abund))
  })
```

# graph model test

## summary of a few
```{r}
plot_all(
  "results_graph/numfeatures20"
)
```

```{r}
plot_all(
  "results_graph/numfeatures200"
)
```

```{r}
plot_all(
  "results_graph/results_20230609_predwindows_randers",
  add_dataset_info = "predwindow"
)
```

```{r}
plot_all(
  "results_graph/results_20230619_predwindows_aae",
  add_dataset_info = "predwindow"
)
```

## prediction window tests

### AAE - abund clustering
```{r}
#visualize the accuracy depending on prediction window length
runs <- list.dirs(
  "results_graph/results_20230619_predwindows_aae",
  recursive = FALSE,
  full.names = TRUE
)
AAE_predwindowtest <- lapply(
  runs,
  function(rundir) {
    d <- amp_export_long(
      combine_abund(
        rundir,
        cluster_type = "abund"
      ),
      tax_levels = "OTU",
      metadata_vars = c("Date", "split_dataset")
    )
    d[, dataset := basename(rundir)]
  }
)
d <- rbindlist(AAE_predwindowtest)
d[, dataset := factor(
  dataset,
  levels = unique(dataset)[order(as.integer(gsub("[^0-9]*", "", unique(dataset))))])
]

plot_asv1 <- plot_timeseries(
  d[grepl("^ASV1;", OTU)],
  save = FALSE
) +
  facet_grid(rows = vars(dataset))

plot_asv2 <- plot_timeseries(
  d[grepl("^ASV2;", OTU)],
  save = FALSE
) +
  facet_grid(rows = vars(dataset))

plot_asv24 <- plot_timeseries(
  d[grepl("^ASV24;", OTU)],
  save = FALSE
) +
  facet_grid(rows = vars(dataset))

ggsave("results_graph/results_20230619_predwindows_aae/asv1_abund.png", plot = plot_asv1)
ggsave("results_graph/results_20230619_predwindows_aae/asv2_abund.png", plot = plot_asv2)
ggsave("results_graph/results_20230619_predwindows_aae/asv24_abund.png", plot = plot_asv24)
#plot_asv24 <- plot_timeseries(ASV24, save = FALSE) +
#  theme(legend.position = "bottom") +
#  ggtitle("ASV24 - Nitrospira, defluvii")

```

### AAE - IDEC clustering
```{r}
#visualize the accuracy depending on prediction window length
runs <- list.dirs(
  "results_graph/results_20230619_predwindows_aae",
  recursive = FALSE,
  full.names = TRUE
)
AAE_predwindowtest <- lapply(
  runs,
  function(rundir) {
    d <- amp_export_long(
      combine_abund(
        rundir,
        cluster_type = "idec"
      ),
      tax_levels = "OTU",
      metadata_vars = c("Date", "split_dataset")
    )
    d[, dataset := basename(rundir)]
  }
)
d <- rbindlist(AAE_predwindowtest)
d[, dataset := factor(
  dataset,
  levels = unique(dataset)[order(as.integer(gsub("[^0-9]*", "", unique(dataset))))])
]

plot_asv1 <- plot_timeseries(
  d[grepl("^ASV1;", OTU)],
  save = FALSE
) +
  facet_grid(rows = vars(dataset))

plot_asv2 <- plot_timeseries(
  d[grepl("^ASV2;", OTU)],
  save = FALSE
) +
  facet_grid(rows = vars(dataset))

plot_asv24 <- plot_timeseries(
  d[grepl("^ASV24;", OTU)],
  save = FALSE
) +
  facet_grid(rows = vars(dataset))

ggsave("results_graph/results_20230619_predwindows_aae/asv1_idec.png", plot = plot_asv1)
ggsave("results_graph/results_20230619_predwindows_aae/asv2_idec.png", plot = plot_asv2)
ggsave("results_graph/results_20230619_predwindows_aae/asv24_idec.png", plot = plot_asv24)
#plot_asv24 <- plot_timeseries(ASV24, save = FALSE) +
#  theme(legend.position = "bottom") +
#  ggtitle("ASV24 - Nitrospira, defluvii")

```

```{r}
#visualize the accuracy depending on prediction window length
runs <- list.dirs(
  "results_graph/results_20230619_predwindows_aae",
  recursive = FALSE,
  full.names = TRUE
)
AAE_predwindowtest <- lapply(
  runs,
  function(rundir) {
    d <- amp_export_long(
      combine_abund(
        rundir,
        cluster_type = "func"
      ),
      tax_levels = "OTU",
      metadata_vars = c("Date", "split_dataset")
    )
    d[, dataset := basename(rundir)]
  }
)
d <- rbindlist(AAE_predwindowtest)
d[, dataset := factor(
  dataset,
  levels = unique(dataset)[order(as.integer(gsub("[^0-9]*", "", unique(dataset))))])
]

plot_asv1 <- plot_timeseries(
  d[grepl("^ASV1;", OTU)],
  save = FALSE
) +
  facet_grid(rows = vars(dataset))

plot_asv2 <- plot_timeseries(
  d[grepl("^ASV2;", OTU)],
  save = FALSE
) +
  facet_grid(rows = vars(dataset))

plot_asv24 <- plot_timeseries(
  d[grepl("^ASV24;", OTU)],
  save = FALSE
) +
  facet_grid(rows = vars(dataset))

ggsave("results_graph/results_20230619_predwindows_aae/asv1_func.png", plot = plot_asv1)
ggsave("results_graph/results_20230619_predwindows_aae/asv2_func.png", plot = plot_asv2)
ggsave("results_graph/results_20230619_predwindows_aae/asv24_func.png", plot = plot_asv24)
#plot_asv24 <- plot_timeseries(ASV24, save = FALSE) +
#  theme(legend.position = "bottom") +
#  ggtitle("ASV24 - Nitrospira, defluvii")
```

```{r}
results_batch_dir <- "results_graph/numfeatures20"
wwtp_results <- list.dirs(
  results_batch_dir,
  full.names = TRUE,
  recursive = FALSE
)

plots <- lapply(
  wwtp_results,
  function(wwtp) {
    plot <- wwtp %>%
      combine_abund(cluster_type = "abund") %>%
      amp_ordinate(
        type = "pcoa",
        distmeasure = "bray",
        transform = "none",
        filter_species = 0,
        sample_color_by = "split_dataset",
        sample_trajectory = "Date",
        sample_trajectory_group = "Date"
      ) +
        scale_color_manual(
          values = c("grey80", RColorBrewer::brewer.pal(3, "Set2")[c(1:3)])
        ) +
        theme(legend.title = element_blank())
    ggsave(filename = file.path(results_batch_dir, paste0("PCoA - ", basename(wwtp), ".png")), plot = plot)
    return(plot)
  }
)
names(plots) <- basename(wwtp_results)
hideme <- lapply(plots, print)
```